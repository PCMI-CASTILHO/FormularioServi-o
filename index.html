<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Formul√°rio Servi√ßo">
    <title>Formul√°rio de Servi√ßo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<link rel="manifest" href="./manifest.json">
	<meta name="theme-color" content="#1f2937">
	<!-- jsPDF e AutoTable -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
	
	<script src="https://cdn.jsdelivr.net/npm/idb@8/build/umd.js"></script>

	<script>
	if ("serviceWorker" in navigator) {
		navigator.serviceWorker.register("./sw.js");
	}
	</script>

    <style>
        :root {
            --primary: #3b82f6;
            --secondary: #1e40af;
            --accent: #f59e0b;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        
        .signature-canvas {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background-color: white;
            cursor: crosshair;
            touch-action: none;
        }
        
        .photo-preview {
            border-radius: 8px;
            object-fit: cover;
            height: 120px;
            width: 120px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary);
        }
        
        .btn-secondary {
            background-color: #f1f5f9;
            color: #475569;
            border: 1px solid #cbd5e1;
        }
        
        .btn-secondary:hover {
            background-color: #e2e8f0;
        }
        
        .form-section {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .form-section h2 {
            color: #1e293b;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background-color: #10b981;
        }
        
        .status-offline {
            background-color: #ef4444;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }
        
        .modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            display: none;
        }
        
        .notification.success {
            background-color: #10b981;
        }
        
        .notification.error {
            background-color: #ef4444;
        }
        
        .notification.info {
            background-color: #3b82f6;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center">
                <div class="bg-blue-600 text-white p-2 rounded-lg mr-3">
                    <i class="fas fa-tools text-xl"></i>
                </div>
                <h1 class="text-xl font-bold text-gray-800">Formul√°rio de Servi√ßo</h1>
            </div>
            <div class="flex items-center space-x-4">
                <div id="status" class="flex items-center text-sm">
                    <span id="status-indicator" class="status-indicator status-offline"></span>
                    <span id="status-text">Offline</span>
                </div>
                <button id="sync-btn" class="btn-primary px-4 py-2 rounded-lg flex items-center relative">
                    <i class="fas fa-sync-alt mr-2"></i> Sincronizar
                    <span id="sync-badge" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full text-xs w-5 h-5 flex items-center justify-center hidden">0</span>
                </button>
                <button id="export-btn" class="btn-primary px-4 py-2 rounded-lg flex items-center">
                    <i class="fas fa-download mr-2"></i> Salvar
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <section class="form-section">
            <h2 class="text-xl font-semibold flex items-center">
                <i class="fas fa-clipboard-list text-blue-600 mr-2"></i> Dados do Servi√ßo
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div>
                        <label for="cliente" class="block text-sm font-medium text-gray-700 mb-1">Cliente *</label>
                        <input type="text" id="cliente" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="cidade" class="block text-sm font-medium text-gray-700 mb-1">Cidade - UF *</label>
                        <input type="text" id="cidade" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="equipamento" class="block text-sm font-medium text-gray-700 mb-1">Equipamento *</label>
                        <select id="equipamento" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Selecione o equipamento</option>
                            <option value="SELAVES WI-FI">SELAVES WI-FI</option>
                            <option value="SELAVES">SELAVES</option>
                            <option value="PS/SEL - WIFI">PS/SEL - WIFI</option>
                            <option value="BD15-SD/PS">BD15-SD/PS</option>
                            <option value="BD15-SD/SEL">BD15-SD/SEL</option>
                            <option value="BD15-BT">BD15-BT</option>
                            <option value="BCD-15">BCD-15</option>
                            <option value="SP-501">SP-501</option>
                            <option value="SP-300">SP-300</option>
                            <option value="SP-SEQ">SP-SEQ</option>
                            <option value="CS-P">CS-P</option>
                            <option value="CS-R">CS-R</option>
                            <option value="OUTRO">OUTRO</option>
                        </select>
                        <input type="text" id="equipamento-outro" placeholder="Especifique o equipamento" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mt-2 hidden">
                    </div>
                    
                    <div>
                        <label for="tecnico" class="block text-sm font-medium text-gray-700 mb-1">T√©cnico *</label>
                        <input type="text" id="tecnico" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="servico" class="block text-sm font-medium text-gray-700 mb-1">Servi√ßo Prestado *</label>
                        <select id="servico" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Selecione o tipo de servi√ßo</option>
                            <option value="INSTALA√á√ÉO">INSTALA√á√ÉO</option>
                            <option value="STARTUP">STARTUP</option>
                            <option value="MANUTEN√á√ÉO">MANUTEN√á√ÉO</option>
                        </select>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="data-inicial" class="block text-sm font-medium text-gray-700 mb-1">Data Inicial *</label>
                            <input type="date" id="data-inicial" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="hora-inicial" class="block text-sm font-medium text-gray-700 mb-1">Hora Inicial *</label>
                            <input type="time" id="hora-inicial" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="data-final" class="block text-sm font-medium text-gray-700 mb-1">Data Final *</label>
                            <input type="date" id="data-final" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="hora-final" class="block text-sm font-medium text-gray-700 mb-1">Hora Final *</label>
                            <input type="time" id="hora-final" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    
                    <div>
                        <label for="veiculo" class="block text-sm font-medium text-gray-700 mb-1">Ve√≠culo</label>
                        <input type="text" id="veiculo" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="estoque" class="block text-sm font-medium text-gray-700 mb-1">Estoque</label>
                        <select id="estoque" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Selecione o estoque</option>
                            <option value="ESTOQUE SELAVES 16">ESTOQUE SELAVES 16</option>
                            <option value="ESTOQUE SELAVES 22">ESTOQUE SELAVES 22</option>
                            <option value="ESTOQUE SELAVES 29">ESTOQUE SELAVES 29</option>
                            <option value="ESTOQUE SELAVES 44">ESTOQUE SELAVES 44</option>
                            <option value="ESTOQUE SELAVES 53">ESTOQUE SELAVES 53</option>
                            <option value="ESTOQUE SELAVES 54">ESTOQUE SELAVES 54</option>
                            <option value="ESTOQUE SP-501 48">ESTOQUE SP-501 48</option>
                            <option value="ESTOQUE SP-501 NOVO 01">ESTOQUE SP-501 NOVO 01</option>
                            <option value="ESTOQUE SP-501 NOVO 02">ESTOQUE SP-501 NOVO 02</option>
                            <option value="ESTOQUE SEQ GIRADI">ESTOQUE SEQ GIRADI</option>
                            <option value="ESTOQUE SEQ MATHEUS">ESTOQUE SEQ MATHEUS</option>
                            <option value="ESTOQUE SEQ LEONARDO">ESTOQUE SEQ LEONARDO</option>
                            <option value="ESTOQUE SEQ CAROBA">ESTOQUE SEQ CAROBA</option>
                            <option value="ESTOQUE SEQ LUIZ V.">ESTOQUE SEQ LUIZ V.</option>
                            <option value="ESTOQUE SEQ ARILDO">ESTOQUE SEQ ARILDO</option>
                            <option value="CS 55">CS 55</option>
                            <option value="CS 56">CS 56</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="numero-serie" class="block text-sm font-medium text-gray-700 mb-1">N¬∫ de S√©rie</label>
                        <input type="text" id="numero-serie" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="####/ano">
                    </div>
                </div>
            </div>
        </section>

        <section class="form-section">
            <h2 class="text-xl font-semibold flex items-center">
                <i class="fas fa-file-alt text-blue-600 mr-2"></i> Relat√≥rio da M√°quina
            </h2>
            
            <div>
                <label for="relatorio-maquina" class="block text-sm font-medium text-gray-700 mb-1">Defeitos Encontrados e Solu√ß√£o *</label>
                <textarea id="relatorio-maquina" rows="5" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Descreva os defeitos encontrados e as solu√ß√µes aplicadas..."></textarea>
            </div>
        </section>

        <section class="form-section">
            <h2 class="text-xl font-semibold flex items-center">
                <i class="fas fa-camera text-blue-600 mr-2"></i> Fotos da M√°quina
            </h2>
            
            <div class="mb-4">
                <input type="file" id="fotos-input" accept="image/*" multiple class="hidden">
                <button id="add-fotos-btn" class="btn-secondary px-4 py-2 rounded-lg flex items-center">
                    <i class="fas fa-plus mr-2"></i> Adicionar Fotos
                </button>
                <p class="text-sm text-gray-500 mt-1">M√°ximo de 10 fotos</p>
            </div>
            
            <div id="fotos-preview" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
            </div>
        </section>

        <section class="form-section">
            <h2 class="text-xl font-semibold flex items-center">
                <i class="fas fa-signature text-blue-600 mr-2"></i> Assinaturas
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Assinatura do Cliente *</h3>
                    <div class="mb-2">
                        <label for="cliente-nome" class="block text-sm font-medium text-gray-700 mb-1">Nome Completo *</label>
                        <input type="text" id="cliente-nome" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mb-2">
                        <label for="cliente-email" class="block text-sm font-medium text-gray-700 mb-1">E-mail *</label>
                        <input type="email" id="cliente-email" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <canvas id="assinatura-cliente" class="signature-canvas w-full h-40"></canvas>
                    <button id="limpar-cliente" class="mt-2 text-sm text-red-500 hover:text-red-700 transition duration-150">
                        <i class="fas fa-eraser mr-1"></i> Limpar Assinatura
                    </button>
                </div>
                
                <div>
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Assinatura do T√©cnico *</h3>
                    <div class="mb-2">
                        <label for="tecnico-nome" class="block text-sm font-medium text-gray-700 mb-1">Nome Completo *</label>
                        <input type="text" id="tecnico-nome" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <canvas id="assinatura-tecnico" class="signature-canvas w-full h-40"></canvas>
                    <button id="limpar-tecnico" class="mt-2 text-sm text-red-500 hover:text-red-700 transition duration-150">
                        <i class="fas fa-eraser mr-1"></i> Limpar Assinatura
                    </button>
                </div>
            </div>
        </section>

        <section class="form-section">
            <h2 class="text-xl font-semibold flex items-center">
                <i class="fas fa-boxes text-blue-600 mr-2"></i> Materiais Utilizados
            </h2>
            
            <div class="mb-4">
                <div class="flex space-x-2">
                    <input type="text" id="material-input" list="materiais-list" placeholder="Digite c√≥digo ou nome do material" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <datalist id="materiais-list"></datalist>
                    <input type="number" id="material-qtd" min="1" placeholder="Qtd" class="w-24 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <button id="add-material-btn" class="btn-primary px-4 py-2 rounded-lg">
                        <i class="fas fa-plus mr-1"></i> Adicionar
                    </button>
                </div>
            </div>
            
            <div id="materiais-lista" class="space-y-2">
            </div>
        </section>
    </main>

    <div id="image-modal" class="modal">
        <span class="modal-close">&times;</span>
        <img class="modal-content" id="modal-image">
    </div>

    <div id="notification" class="notification hidden">
        <div class="flex items-center">
            <i id="notification-icon" class="mr-2"></i>
            <span id="notification-text"></span>
        </div>
    </div>

    <script>
        // Dados do estoque (mantido conforme original - muito extenso para reescrever)
        const estoqueData = [
            { codigo: '9318', material: 'ABRA√áADEIRA NYLON 100MMX2,5MM' },
            { codigo: '3296', material: 'ABRA√áADEIRA NYLON 4,6MMX200MM' }
            // ... resto dos materiais
        ];

        // Estado da aplica√ß√£o
        let state = {
            fotos: [],
            materiais: [],
            assinaturas: {
                cliente: null,
                tecnico: null
            },
            pdfFicha: null,
            pdfRelatorio: null
        };

        // Configura√ß√µes de sincroniza√ß√£o
        const SYNC_CONFIG = {
            endpoint: 'https://vps.pesoexato.com/servico_set',
            interval: 5000,
            maxRetention: 14 * 24 * 60 * 60 * 1000
        };

        // Configura√ß√£o do IndexedDB
        const DB_NAME = 'FormulariosDB';
        const DB_VERSION = 4;
        const STORE_NAME = 'formularios';

        let dbPromise;
        let syncState = {
            pendingCount: 0,
            isSyncing: false,
            syncInterval: null
        };

        let syncBtn, syncBadge, syncIcon;

        // Elementos DOM
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const exportBtn = document.getElementById('export-btn');
        const fotosInput = document.getElementById('fotos-input');
        const addFotosBtn = document.getElementById('add-fotos-btn');
        const fotosPreview = document.getElementById('fotos-preview');
        const materialInput = document.getElementById('material-input');
        const materialQtd = document.getElementById('material-qtd');
        const addMaterialBtn = document.getElementById('add-material-btn');
        const materiaisLista = document.getElementById('materiais-lista');
        const materiaisDatalist = document.getElementById('materiais-list');
        const equipamentoSelect = document.getElementById('equipamento');
        const equipamentoOutro = document.getElementById('equipamento-outro');
        const notification = document.getElementById('notification');
        const notificationIcon = document.getElementById('notification-icon');
        const notificationText = document.getElementById('notification-text');
        const imageModal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        const modalClose = document.querySelector('.modal-close');

        // Canvas de assinatura
        const canvasCliente = document.getElementById('assinatura-cliente');
        const canvasTecnico = document.getElementById('assinatura-tecnico');
        const ctxCliente = canvasCliente.getContext('2d');
        const ctxTecnico = canvasTecnico.getContext('2d');
        let isDrawingCliente = false;
        let isDrawingTecnico = false;
        let lastXCliente = 0;
        let lastYCliente = 0;
        let lastXTecnico = 0;
        let lastYTecnico = 0;

        // Fun√ß√£o para gerar chave √∫nica
        function generateUniqueKey() {
            const timestamp = Date.now().toString(36);
            const randomStr = Math.random().toString(36).substr(2, 9);
            return `form_${timestamp}_${randomStr}`;
        }

        // Fun√ß√µes auxiliares
        function dataURItoBlob(dataURI) {
            const byteString = atob(dataURI.split(',')[1]);
            const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ab], { type: mimeString });
        }

        async function compressPDF(blob, quality = 0.6) {
            return new Promise((resolve) => {
                resolve(blob);
            });
        }

        function blobToBase64(blob) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        }

        function showNotification(message, type) {
            notification.className = `notification ${type}`;
            notificationIcon.className = type === 'success' ? 'fas fa-check-circle' : 
                                       type === 'error' ? 'fas fa-exclamation-circle' : 
                                       'fas fa-info-circle';
            notificationText.textContent = message;
            
            notification.style.display = 'flex';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        function updateOnlineStatus() {
            if (navigator.onLine) {
                statusIndicator.className = 'status-indicator status-online';
                statusText.textContent = 'Online';
            } else {
                statusIndicator.className = 'status-indicator status-offline';
                statusText.textContent = 'Offline';
            }
        }

        // Inicializa√ß√£o do IndexedDB
        function initDB() {
            if (dbPromise) return dbPromise;

            dbPromise = idb.openDB(DB_NAME, DB_VERSION, {
                upgrade(db, oldVersion) {
                    console.log('Migrando banco de dados da vers√£o', oldVersion, 'para', DB_VERSION);
                    
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        console.log('Criando nova store:', STORE_NAME);
                        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        store.createIndex('cliente', 'cliente', { unique: false });
                        store.createIndex('servico', 'servico', { unique: false });
                        store.createIndex('sincronizado', 'sincronizado', { unique: false });
                    }
                }
            }).then(db => {
                console.log('Banco de dados inicializado com sucesso');
                return db;
            }).catch(error => {
                console.error('Erro ao inicializar banco de dados:', error);
                dbPromise = null;
                throw error;
            });
            
            return dbPromise;
        }

        async function recriarBancoDados() {
            try {
                console.log('Tentando recriar banco de dados...');
                if (dbPromise) {
                    const db = await dbPromise;
                    db.close();
                    dbPromise = null;
                }
                
                await idb.deleteDB(DB_NAME);
                console.log('Banco antigo deletado');
                
                await initDB();
                console.log('Novo banco criado com sucesso');
                
            } catch (error) {
                console.error('Falha ao recriar banco de dados:', error);
                throw error;
            }
        }

        // Sincroniza√ß√£o
        async function getPendingForms() {
            try {
                const db = await initDB();
                const allForms = await db.getAll(STORE_NAME);
                
                const cutoffTime = Date.now() - SYNC_CONFIG.maxRetention;
                const pendingForms = allForms.filter(form => 
                    !form.sincronizado && form.id > cutoffTime
                );
                
                return pendingForms;
            } catch (error) {
                console.error('Erro ao buscar formul√°rios pendentes:', error);
                return [];
            }
        }

        async function markFormAsSynced(formId) {
            try {
                const db = await initDB();
                const form = await db.get(STORE_NAME, formId);
                
                if (form) {
                    form.sincronizado = true;
                    form.syncedAt = new Date().toISOString();
                    await db.put(STORE_NAME, form);
                }
            } catch (error) {
                console.error('Erro ao marcar formul√°rio como sincronizado:', error);
            }
        }

        async function updatePendingCount() {
            try {
                const pendingForms = await getPendingForms();
                syncState.pendingCount = pendingForms.length;
                updateSyncBadge();
            } catch (error) {
                console.error('Erro ao atualizar contagem pendente:', error);
            }
        }

        function updateSyncBadge() {
            if (syncState.pendingCount > 0) {
                syncBadge.textContent = syncState.pendingCount;
                syncBadge.classList.remove('hidden');
            } else {
                syncBadge.classList.add('hidden');
            }
        }

        function updateSyncButtonState(syncing) {
            if (syncing) {
                syncIcon.classList.add('fa-spin');
                syncBtn.disabled = true;
                syncBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                syncIcon.classList.remove('fa-spin');
                syncBtn.disabled = false;
                syncBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        async function syncSingleForm(form) {
            try {
                const endpoint = SYNC_CONFIG.endpoint;
                const dados = form.formData || {};
                
                const jsonDados = {
                    id: form.id,
                    createdAt: form.createdAt || new Date().toISOString(),
                    cliente: dados.cliente || '',
                    tecnico: dados.tecnico || '',
                    servico: dados.servico || '',
                    cidade: dados.cidade || '',
                    equipamento: dados.equipamento || '',
                    numeroSerie: dados.numeroSerie || '',
                    dataInicial: dados.dataInicial || '',
                    dataFinal: dados.dataFinal || '',
                    horaInicial: dados.horaInicial || '',
                    horaFinal: dados.horaFinal || '',
                    veiculo: dados.veiculo || '',
                    estoque: dados.estoque || '',
                    relatorioMaquina: dados.relatorioMaquina || '',
                    materiais: Array.isArray(form.materiais) ? form.materiais : [],
                    chaveUnica: form.chaveUnica || ''
                };

                if (form.pdfFicha) {
                    const pdfFichaBase64 = form.pdfFicha.split(',')[1];
                    if (pdfFichaBase64) {
                        jsonDados.pdfFicha = pdfFichaBase64;
                        console.log('üìÑ PDF Ficha preparado, tamanho:', pdfFichaBase64.length);
                    }
                }
                
                if (form.pdfRelatorio) {
                    const pdfRelatorioBase64 = form.pdfRelatorio.split(',')[1];
                    if (pdfRelatorioBase64) {
                        jsonDados.pdfRelatorio = pdfRelatorioBase64;
                        console.log('üìÑ PDF Relat√≥rio preparado, tamanho:', pdfRelatorioBase64.length);
                    }
                }

                const payload = {
                    json_dados: jsonDados,
                    chave: form.chaveUnica || ''
                };

                console.log('üì§ Enviando para servidor');

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    let errorBody = '';
                    try { 
                        errorBody = await response.text(); 
                        console.error('‚ùå Corpo do erro:', errorBody);
                    } catch(e) { 
                        errorBody = 'N√£o foi poss√≠vel ler o corpo do erro';
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorBody}`);
                }
                
                const result = await response.json();
                console.log('‚úÖ Sincronizado com sucesso:', result);
                return true;
                
            } catch (error) {
                console.error('Erro ao sincronizar formul√°rio:', error);
                return false;
            }
        }

        async function attemptSync(isManual = false) {
            if (syncState.isSyncing) return;
            
            try {
                syncState.isSyncing = true;
                updateSyncButtonState(true);
                
                const pendingForms = await getPendingForms();
                
                if (pendingForms.length === 0) {
                    if (isManual) {
                        showNotification('Nenhum formul√°rio pendente para sincronizar', 'info');
                    }
                    return;
                }
                
                if (isManual) {
                    showNotification(`Sincronizando ${pendingForms.length} formul√°rio(s)...`, 'info');
                }
                
                let successCount = 0;
                let errorCount = 0;
                
                for (const form of pendingForms) {
                    try {
                        const success = await syncSingleForm(form);
                        if (success) {
                            successCount++;
                            await markFormAsSynced(form.id);
                            await new Promise(resolve => setTimeout(resolve, 500));
                        } else {
                            errorCount++;
                        }
                    } catch (error) {
                        console.error(`Erro ao sincronizar formul√°rio ${form.id}:`, error);
                        errorCount++;
                    }
                }
                
                await updatePendingCount();
                await renderFormulariosSalvos();
                
                if (isManual || successCount > 0) {
                    const message = successCount > 0 
                        ? `${successCount} formul√°rio(s) sincronizado(s) com sucesso${errorCount > 0 ? `, ${errorCount} falha(s)` : ''}`
                        : 'Falha na sincroniza√ß√£o';
                        
                    showNotification(message, successCount > 0 ? 'success' : 'error');
                }
                
            } catch (error) {
                console.error('Erro geral na sincroniza√ß√£o:', error);
                if (isManual) {
                    showNotification('Erro na sincroniza√ß√£o', 'error');
                }
            } finally {
                syncState.isSyncing = false;
                updateSyncButtonState(false);
            }
        }

        async function manualSync() {
            if (!navigator.onLine) {
                showNotification('Sem conex√£o para sincronizar', 'error');
                return;
            }
            
            if (syncState.isSyncing) {
                showNotification('Sincroniza√ß√£o j√° em andamento', 'info');
                return;
            }
            
            showNotification('Iniciando sincroniza√ß√£o manual...', 'info');
            await attemptSync(true);
        }

        function startSyncInterval() {
            if (!navigator.onLine) return;
            
            stopSyncInterval();
            
            syncState.syncInterval = setInterval(() => {
                if (navigator.onLine && !syncState.isSyncing) {
                    attemptSync();
                }
            }, SYNC_CONFIG.interval);
        }

        function stopSyncInterval() {
            if (syncState.syncInterval) {
                clearInterval(syncState.syncInterval);
                syncState.syncInterval = null;
            }
        }

        function handleOnlineStatus() {
            showNotification('Conex√£o restaurada - Sincronizando...', 'success');
            startSyncInterval();
            attemptSync();
        }

        function handleOfflineStatus() {
            showNotification('Sem conex√£o - Sincroniza√ß√£o pausada', 'error');
            stopSyncInterval();
            updateSyncButtonState(false);
        }

        function initSync() {
            syncBtn = document.getElementById('sync-btn');
            syncBadge = document.getElementById('sync-badge');
            syncIcon = syncBtn.querySelector('i');
            
            startSyncInterval();
            updatePendingCount();
            
            window.addEventListener('online', handleOnlineStatus);
            window.addEventListener('offline', handleOfflineStatus);
        }

        function collectFormData() {
            return {
                cliente: document.getElementById('cliente').value,
                cidade: document.getElementById('cidade').value,
                equipamento: document.getElementById('equipamento').value,
                equipamentoOutro: document.getElementById('equipamento-outro').value,
                tecnico: document.getElementById('tecnico').value,
                servico: document.getElementById('servico').value,
                dataInicial: document.getElementById('data-inicial').value,
                horaInicial: document.getElementById('hora-inicial').value,
                dataFinal: document.getElementById('data-final').value,
                horaFinal: document.getElementById('hora-final').value,
                veiculo: document.getElementById('veiculo').value,
                estoque: document.getElementById('estoque').value,
                numeroSerie: document.getElementById('numero-serie').value,
                relatorioMaquina: document.getElementById('relatorio-maquina').value,
                clienteNome: document.getElementById('cliente-nome').value,
                clienteEmail: document.getElementById('cliente-email').value,
                tecnicoNome: document.getElementById('tecnico-nome').value
            };
        }

        function validateForm() {
            const requiredFields = [
                'cliente', 'cidade', 'equipamento', 'tecnico', 'servico',
                'data-inicial', 'hora-inicial', 'data-final', 'hora-final',
                'relatorio-maquina', 'cliente-nome', 'cliente-email', 'tecnico-nome'
            ];

            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    showNotification(`Preencha o campo: ${field.labels[0].textContent}`, 'error');
                    field.focus();
                    return false;
                }
            }

            if (!state.assinaturas.cliente) {
                showNotification('Assinatura do cliente √© obrigat√≥ria', 'error');
                return false;
            }

            if (!state.assinaturas.tecnico) {
                showNotification('Assinatura do t√©cnico √© obrigat√≥ria', 'error');
                return false;
            }

            return true;
        }

        async function reduzirImagem(imgDataUrl, maxWidth = 800, quality = 0.6) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = Math.min(maxWidth / img.width, 1);
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d');
                    
                    ctx.imageSmoothingQuality = 'low';
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = imgDataUrl;
            });
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function carregarImagem(src) {
            return new Promise(resolve => {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.onload = () => resolve(img);
                img.onerror = () => resolve(null);
                img.src = src;
            });
        }

        async function gerarFichaPDF(formData, materiais, fotos, assinaturas) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF("p", "mm", "a4");

            doc.setProperties({
                title: `Ficha Manuten√ß√£o - ${formData.cliente || 'Cliente'}`,
                subject: 'Ficha de Manuten√ß√£o',
                creator: 'Sistema Selaves',
                compression: true
            });
            
            const logo = await carregarImagem("Logo.png");
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            let y = 20;

            doc.setFillColor(0, 82, 163);
            doc.rect(0, 0, pageWidth, 17, 'F');
            
            if (logo) doc.addImage(logo, "PNG", 10, 1.5, 30, 15);
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('FICHA DE MANUTEN√á√ÉO', pageWidth / 2, 11, { align: 'center' });
            y = 22;

            const tableStyles4Col = {
                styles: { fontSize: 8, cellPadding: 3, halign: 'center' },
                headStyles: { fillColor: [0, 82, 163], textColor: 255, fontStyle: 'bold', halign: 'center' },
                columnStyles: {
                    0: { cellWidth: (pageWidth - 16) / 4 },
                    1: { cellWidth: (pageWidth - 16) / 4 },
                    2: { cellWidth: (pageWidth - 16) / 4 },
                    3: { cellWidth: (pageWidth - 16) / 4 }
                },
                margin: { left: 8, right: 8 },
                theme: 'grid'
            };
            
            const table1Data = [[
                formData.cliente || '-',
                formData.cidade || '-',
                formData.equipamento || '-',
                formData.numeroSerie || '-'
            ]];
            
            doc.autoTable({
                startY: y,
                head: [['CLIENTE', 'CIDADE', 'EQUIPAMENTO', 'N¬∫ S√âRIE']],
                body: table1Data,
                ...tableStyles4Col
            });
            
            y = doc.lastAutoTable.finalY + 4;
            
            const table2Data = [[
                formData.tecnico || '-',
                formData.veiculo || '-',
                formData.estoque || '-',
                formData.dataInicial ? formatDate(formData.dataInicial) : '-'
            ]];
            
            doc.autoTable({
                startY: y,
                head: [['T√âCNICO', 'VE√çCULO', 'ESTOQUE', 'DATA']],
                body: table2Data,
                ...tableStyles4Col
            });
            
            y = doc.lastAutoTable.finalY + 8;
            
            doc.setTextColor(0, 82, 163);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('MATERIAIS UTILIZADOS', 10, y);
            y += 6;
            
            const materialsData = [];
            if (materiais && materiais.length > 0) {
                materiais.forEach(material => {
                    materialsData.push([
                        material.codigo || '',
                        material.quantidade || '',
                        material.descricao || ''
                    ]);
                });
            } else {
                materialsData.push(['', '', 'Nenhum material utilizado.']);
            }
            
            doc.autoTable({
                startY: y,
                head: [['C√ìDIGO', 'QNTD', 'MATERIAIS']],
                body: materialsData,
                styles: { fontSize: 8, cellPadding: 3 },
                headStyles: { fillColor: [0, 82, 163], textColor: 255, fontStyle: 'bold', halign: 'center' },
                columnStyles: {
                    0: { cellWidth: 25, halign: 'center' },
                    1: { cellWidth: 20, halign: 'center' },
                    2: { cellWidth: pageWidth - 16 - 45, halign: 'left' }
                },
                margin: { left: 8, right: 8 },
                theme: 'grid'
            });
            
            y = doc.lastAutoTable.finalY + 15;
            
            const signatureWidth = 50;
            const signatureHeight = 25;
            const spacing = (pageWidth - (signatureWidth * 2)) / 3;
            
            if (assinaturas && assinaturas.tecnico) {
                try {
                    doc.addImage(assinaturas.tecnico, 'PNG', spacing, y, signatureWidth, signatureHeight);
                } catch (e) {
                    console.error('Erro ao adicionar assinatura do t√©cnico:', e);
                }
            }
            
            if (assinaturas && assinaturas.cliente) {
                try {
                    doc.addImage(assinaturas.cliente, 'PNG', spacing * 2 + signatureWidth, y, signatureWidth, signatureHeight);
                } catch (e) {
                    console.error('Erro ao adicionar assinatura do cliente:', e);
                }
            }
            
            y += signatureHeight + 2;
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            doc.line(spacing, y, spacing + signatureWidth, y);
            doc.line(spacing * 2 + signatureWidth, y, spacing * 2 + signatureWidth * 2, y);
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(7);
            doc.setFont('helvetica', 'normal');
            doc.text('T√âCNICO', spacing + signatureWidth / 2, y + 3, { align: 'center' });
            doc.text('CLIENTE', spacing * 2 + signatureWidth + signatureWidth / 2, y + 3, { align: 'center' });
            
            const pdfOutput = doc.output('datauristring');
            const pdfBlob = dataURItoBlob(pdfOutput);
            const compressedPdf = await compressPDF(pdfBlob);
            
            state.pdfFicha = await blobToBase64(compressedPdf);
            console.log('üìÑ PDF Ficha comprimido, tamanho:', state.pdfFicha.length);
        }

        async function gerarRelatorioPDF(formData, materiais, fotos, assinaturas) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF("p", "mm", "a4");

            doc.setProperties({
                title: `Relat√≥rio Servi√ßo - ${formData.cliente || 'Cliente'}`,
                subject: 'Relat√≥rio de Presta√ß√£o de Servi√ßo',
                creator: 'Sistema Selaves',
                compression: true
            });
            
            const logo = await carregarImagem("Logo.png");
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            let y = 20;

            doc.setFillColor(0, 82, 163);
            doc.rect(0, 0, pageWidth, 17, 'F');
            
            if (logo) doc.addImage(logo, "PNG", 10, 1.5, 30, 15);
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('RELAT√ìRIO DE PRESTA√á√ÉO DE SERVI√áO', pageWidth / 2, 11, { align: 'center' });
            y = 22;

            const tableStyles3Col = {
                styles: { fontSize: 8, cellPadding: 3, halign: 'center' },
                headStyles: { fillColor: [0, 82, 163], textColor: 255, fontStyle: 'bold', halign: 'center' },
                columnStyles: {
                    0: { cellWidth: (pageWidth - 16) / 3, halign: 'center' },
                    1: { cellWidth: (pageWidth - 16) / 3, halign: 'center' },
                    2: { cellWidth: (pageWidth - 16) / 3, halign: 'center' }
                },
                margin: { left: 8, right: 8 },
                theme: 'grid'
            };
            
            const table1Data = [[
                formData.cliente || '-',
                formData.cidade || '-',
                formData.equipamento || '-'
            ]];
            
            doc.autoTable({
                startY: y,
                head: [['CLIENTE', 'CIDADE', 'EQUIPAMENTO']],
                body: table1Data,
                ...tableStyles3Col
            });
            
            y = doc.lastAutoTable.finalY + 4;
            
            const table2Data = [[
                formData.tecnico || '-',
                formData.dataInicial ? formatDate(formData.dataInicial) : '-',
                formData.dataFinal ? formatDate(formData.dataFinal) : '-'
            ]];
            
            doc.autoTable({
                startY: y,
                head: [['T√âCNICO', 'DATA INICIAL', 'DATA FINAL']],
                body: table2Data,
                ...tableStyles3Col
            });
            
            y = doc.lastAutoTable.finalY + 4;
            
            const table3Data = [[
                formData.servico || '-',
                formData.horaInicial || '-',
                formData.horaFinal || '-'
            ]];
            
            doc.autoTable({
                startY: y,
                head: [['SERVI√áO', 'HOR√ÅRIO INICIAL', 'HOR√ÅRIO FINAL']],
                body: table3Data,
                ...tableStyles3Col
            });
            
            y = doc.lastAutoTable.finalY + 8;
            
            doc.setTextColor(0, 82, 163);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('RELAT√ìRIO DA M√ÅQUINA', 10, y);
            y += 6;
            
            const relatorio = formData.relatorioMaquina || 'Nenhum relat√≥rio preenchido.';
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            
            const margin = 10;
            const textWidth = pageWidth - (margin * 2);
            const lineHeight = 4.5;
            
            const lines = doc.splitTextToSize(relatorio, textWidth);
            const textHeight = lines.length * lineHeight;
            
            if (y + textHeight + 30 > pageHeight) {
                doc.addPage();
                y = 20;
                doc.setTextColor(0, 82, 163);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('RELAT√ìRIO DA M√ÅQUINA', 10, y);
                y += 6;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
            }
            
            doc.setFillColor(245, 248, 251);
            doc.setDrawColor(208, 218, 230);
            doc.roundedRect(margin - 2, y - 2, textWidth + 4, textHeight + 4, 2, 2, 'FD');
            
            doc.text(lines, margin, y + 2);
            y += textHeight + 10;
            
            if (fotos && fotos.length > 0) {
                if (y + 50 > pageHeight) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setTextColor(0, 82, 163);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('FOTOS DO SERVI√áO', 10, y);
                y += 6;
                
                const numFotos = fotos.length;
                let imgWidth, imgHeight, imgsPerRow;
                
                if (numFotos === 1) {
                    imgWidth = 80;
                    imgHeight = 60;
                    imgsPerRow = 1;
                } else if (numFotos === 2) {
                    imgWidth = 65;
                    imgHeight = 50;
                    imgsPerRow = 2;
                } else if (numFotos === 3) {
                    imgWidth = 50;
                    imgHeight = 40;
                    imgsPerRow = 3;
                } else if (numFotos <= 4) {
                    imgWidth = 45;
                    imgHeight = 35;
                    imgsPerRow = 4;
                } else if (numFotos <= 6) {
                    imgWidth = 45;
                    imgHeight = 35;
                    imgsPerRow = 3;
                } else {
                    imgWidth = 40;
                    imgHeight = 30;
                    imgsPerRow = 4;
                }
                
                const spacing = (pageWidth - 16 - (imgWidth * imgsPerRow)) / (imgsPerRow + 1);
                let currentX = 8 + spacing;
                let currentY = y;
                let photoCount = 0;
                
                for (let i = 0; i < numFotos; i++) {
                    if (photoCount > 0 && photoCount % imgsPerRow === 0) {
                        currentY += imgHeight + 6;
                        
                        if (currentY + imgHeight > pageHeight - 15) {
                            doc.addPage();
                            currentY = 20;
                        }
                        
                        currentX = 8 + spacing;
                    }
                    
                    try {
                        const imgReduzida = await reduzirImagem(fotos[i].data, 900, 0.6);
                        doc.addImage(imgReduzida, 'JPEG', currentX, currentY, imgWidth, imgHeight, '', 'FAST');
                    } catch (e) {
                        console.error('Erro ao adicionar imagem:', e);
                    }
                    
                    currentX += imgWidth + spacing;
                    photoCount++;
                }
                
                y = currentY + imgHeight + 8;
            }
            
            if (y + 35 > pageHeight) {
                doc.addPage();
                y = 20;
            }
            
            const signatureWidth = 50;
            const signatureHeight = 25;
            const spacing = (pageWidth - (signatureWidth * 2)) / 3;
            
            if (assinaturas && assinaturas.tecnico) {
                try {
                    doc.addImage(assinaturas.tecnico, 'PNG', spacing, y, signatureWidth, signatureHeight);
                } catch (e) {
                    console.error('Erro ao adicionar assinatura do t√©cnico:', e);
                }
            }
            
            if (assinaturas && assinaturas.cliente) {
                try {
                    doc.addImage(assinaturas.cliente, 'PNG', spacing * 2 + signatureWidth, y, signatureWidth, signatureHeight);
                } catch (e) {
                    console.error('Erro ao adicionar assinatura do cliente:', e);
                }
            }
            
            y += signatureHeight + 2;
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            doc.line(spacing, y, spacing + signatureWidth, y);
            doc.line(spacing * 2 + signatureWidth, y, spacing * 2 + signatureWidth * 2, y);
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(7);
            doc.setFont('helvetica', 'normal');
            doc.text('T√âCNICO', spacing + signatureWidth / 2, y + 3, { align: 'center' });
            doc.text('CLIENTE', spacing * 2 + signatureWidth + signatureWidth / 2, y + 3, { align: 'center' });
            
            const pdfOutput = doc.output('datauristring');
            const pdfBlob = dataURItoBlob(pdfOutput);
            const compressedPdf = await compressPDF(pdfBlob);
            
            state.pdfRelatorio = await blobToBase64(compressedPdf);
            console.log('üìÑ PDF Relat√≥rio comprimido, tamanho:', state.pdfRelatorio.length);
        }

        async function gerarPDFsAutomaticamente(formData, materiais, fotos, assinaturas) {
            if (!window.jspdf || !window.jspdf.jsPDF) {
                console.warn("jsPDF ainda n√£o carregado, adiando gera√ß√£o...");
                setTimeout(() => gerarPDFsAutomaticamente(formData, materiais, fotos, assinaturas), 500);
                return;
            }

            try {
                console.log("üìÑ Iniciando gera√ß√£o de PDFs...");
                
                await gerarFichaPDF(formData, materiais, fotos, assinaturas);
                await gerarRelatorioPDF(formData, materiais, fotos, assinaturas);

                console.log("‚úÖ PDFs gerados:", {
                    ficha: state.pdfFicha ? state.pdfFicha.length : 0,
                    relatorio: state.pdfRelatorio ? state.pdfRelatorio.length : 0
                });

                await salvarFormularioLocal(formData);

                showNotification("PDFs gerados e formul√°rio salvo com sucesso!", "success");
            } catch (e) {
                console.error("Erro ao gerar PDFs:", e);
                showNotification("Erro ao gerar PDFs", "error");
            }
        }

        async function salvarFormularioLocal() {
            if (!validateForm()) return;
            const f = collectFormData(); 

            const id = Date.now();

            const registro = {
                id: id,
                createdAt: new Date().toISOString(),
                cliente: f.cliente,
                tecnico: f.tecnico,
                servico: f.servico,
                formData: f,
                materiais: state.materiais,
                fotos: state.fotos,
                assinaturas: state.assinaturas,
                pdfFicha: state.pdfFicha || null,
                pdfRelatorio: state.pdfRelatorio || null,
                chaveUnica: generateUniqueKey(),
                sincronizado: false
            };

            console.log('üíæ Salvando no IndexedDB:', {
                temPDFFicha: !!state.pdfFicha,
                temPDFRelatorio: !!state.pdfRelatorio,
                tamanhoFicha: state.pdfFicha ? state.pdfFicha.length : 0,
                tamanhoRelatorio: state.pdfRelatorio ? state.pdfRelatorio.length : 0
            });

            try {
                const db = await initDB();
                await db.put(STORE_NAME, registro);
                await updatePendingCount();

                showNotification('Formul√°rio salvo localmente!', 'success');
                await renderFormulariosSalvos();
                
                if (navigator.onLine) {
                    setTimeout(() => attemptSync(), 1000);
                }
                
            } catch (e) {
                console.error("Erro ao salvar no IndexedDB:", e);
                showNotification('Erro: Falha ao salvar no armazenamento local.', 'error');
            }
        }

        async function renderFormulariosSalvos() {
            const containerId = 'formularios-salvos';
            let container = document.getElementById(containerId);

            if (!container) {
                container = document.createElement('section');
                container.id = containerId;
                container.className = 'form-section';
                const main = document.querySelector('main');
                if (main) {
                    main.appendChild(container);
                } else {
                    console.error("Elemento 'main' n√£o encontrado.");
                    return;
                }
            }

            container.innerHTML = `
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-history text-blue-600 mr-2"></i> Formul√°rios Salvos
                    <span class="ml-2 text-sm bg-gray-200 text-gray-700 px-2 py-1 rounded-full">
                        ${syncState.pendingCount} pendente(s)
                    </span>
                </h2>
                <div id="lista-formularios" class="space-y-2"></div>
            `;

            const lista = container.querySelector('#lista-formularios');

            try {
                const db = await initDB();
                let registros = await db.getAll(STORE_NAME);
                
                registros.sort((a, b) => b.id - a.id); 

                if (registros.length === 0) {
                    lista.innerHTML = `<p class="text-gray-500 text-sm">Nenhum formul√°rio salvo.</p>`;
                    return;
                }

                registros.forEach(registro => {
                    const dataLegivel = new Date(registro.id).toLocaleString();
                    const statusIcon = registro.sincronizado 
                        ? '<i class="fas fa-check-circle text-green-500" title="Sincronizado"></i>'
                        : '<i class="fas fa-clock text-yellow-500" title="Pendente de sincroniza√ß√£o"></i>';
                    
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg shadow-sm';
                    item.innerHTML = `
                        <div class="flex items-center">
                            ${statusIcon}
                            <div class="ml-2">
                                <div class="font-medium text-gray-800">${registro.cliente || '‚Äî'}</div>
                                <div class="text-sm text-gray-500">${registro.servico || '‚Äî'} ‚Ä¢ ${dataLegivel}</div>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button class="btn-secondary px-3 py-1 rounded text-red-600 delete-btn" data-id="${registro.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    lista.appendChild(item);
                });

                lista.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const id = e.currentTarget.dataset.id;
                        removerFormularioLocal(id);
                    });
                });

            } catch (e) {
                console.error("Erro ao renderizar formul√°rios:", e);
                lista.innerHTML = `<p class="text-red-500 text-sm">Erro ao carregar lista de formul√°rios.</p>`;
            }
        }

        async function removerFormularioLocal(id) {
            try {
                const db = await initDB();
                await db.delete(STORE_NAME, Number(id));

                showNotification('Formul√°rio exclu√≠do.', 'info');
                await renderFormulariosSalvos();
                await updatePendingCount();
            } catch (e) {
                console.error("Erro ao remover do IndexedDB:", e);
                showNotification('Erro ao excluir formul√°rio.', 'error');
            }
        }

        function setupEventListeners() {
            exportBtn.addEventListener('click', exportData);
            addFotosBtn.addEventListener('click', () => fotosInput.click());
            fotosInput.addEventListener('change', handleFileSelect);
            addMaterialBtn.addEventListener('click', addMaterial);
            materialInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addMaterial();
            });

            document.getElementById('limpar-cliente').addEventListener('click', () => clearCanvas('cliente'));
            document.getElementById('limpar-tecnico').addEventListener('click', () => clearCanvas('tecnico'));

            equipamentoSelect.addEventListener('change', function() {
                equipamentoOutro.classList.toggle('hidden', this.value !== 'OUTRO');
            });

            modalClose.addEventListener('click', () => {
                imageModal.style.display = 'none';
            });

            window.addEventListener('click', (e) => {
                if (e.target === imageModal) {
                    imageModal.style.display = 'none';
                }
            });

            if (document.getElementById('sync-btn')) {
                document.getElementById('sync-btn').addEventListener('click', manualSync);
            }
        }

        function setupSignatureCanvas(canvas, ctx, tipo) {
            function getMousePos(e) {
                const rect = canvas.getBoundingClientRect();
                return {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            }

            function getTouchPos(e) {
                const rect = canvas.getBoundingClientRect();
                const touch = e.touches[0];
                return {
                    x: touch.clientX - rect.left,
                    y: touch.clientY - rect.top
                };
            }

            function draw(x, y, isCliente) {
                const config = isCliente ? 
                    { ctx: ctxCliente, drawing: isDrawingCliente, lastX: lastXCliente, lastY: lastYCliente } :
                    { ctx: ctxTecnico, drawing: isDrawingTecnico, lastX: lastXTecnico, lastY: lastYTecnico };

                if (!config.drawing) return;

                config.ctx.beginPath();
                config.ctx.moveTo(config.lastX, config.lastY);
                config.ctx.lineTo(x, y);
                config.ctx.stroke();

                if (isCliente) {
                    lastXCliente = x;
                    lastYCliente = y;
                    state.assinaturas.cliente = canvas.toDataURL();
                } else {
                    lastXTecnico = x;
                    lastYTecnico = y;
                    state.assinaturas.tecnico = canvas.toDataURL();
                }
            }

            canvas.addEventListener('mousedown', (e) => {
                if (tipo === 'cliente') {
                    isDrawingCliente = true;
                    const pos = getMousePos(e);
                    lastXCliente = pos.x;
                    lastYCliente = pos.y;
                } else {
                    isDrawingTecnico = true;
                    const pos = getMousePos(e);
                    lastXTecnico = pos.x;
                    lastYTecnico = pos.y;
                }
            });

            canvas.addEventListener('mouseup', () => {
                if (tipo === 'cliente') isDrawingCliente = false;
                else isDrawingTecnico = false;
            });

            canvas.addEventListener('mousemove', (e) => {
                const pos = getMousePos(e);
                draw(pos.x, pos.y, tipo === 'cliente');
            });

            canvas.addEventListener('mouseout', () => {
                if (tipo === 'cliente') isDrawingCliente = false;
                else isDrawingTecnico = false;
            });

            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (tipo === 'cliente') {
                    isDrawingCliente = true;
                    const pos = getTouchPos(e);
                    lastXCliente = pos.x;
                    lastYCliente = pos.y;
                } else {
                    isDrawingTecnico = true;
                    const pos = getTouchPos(e);
                    lastXTecnico = pos.x;
                    lastYTecnico = pos.y;
                }
            });

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const pos = getTouchPos(e);
                draw(pos.x, pos.y, tipo === 'cliente');
            });

            canvas.addEventListener('touchend', () => {
                if (tipo === 'cliente') isDrawingCliente = false;
                else isDrawingTecnico = false;
            });

            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = '#000';
        }

        function clearCanvas(tipo) {
            if (tipo === 'cliente') {
                ctxCliente.clearRect(0, 0, canvasCliente.width, canvasCliente.height);
                state.assinaturas.cliente = null;
            } else {
                ctxTecnico.clearRect(0, 0, canvasTecnico.width, canvasTecnico.height);
                state.assinaturas.tecnico = null;
            }
            showNotification('Assinatura limpa', 'info');
        }

        function populateMaterialsDatalist() {
            estoqueData.forEach(item => {
                const option = document.createElement('option');
                option.value = `${item.codigo} ‚Äî ${item.material}`;
                materiaisDatalist.appendChild(option);
            });
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            
            if (state.fotos.length + files.length > 10) {
                showNotification('M√°ximo de 10 arquivos permitidos', 'error');
                return;
            }

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                if (!file.type.match('image.*')) {
                    showNotification('Apenas imagens s√£o permitidas', 'error');
                    continue;
                }

                const reader = new FileReader();
                
                reader.onload = (function(file) {
                    return function(e) {
                        const fileData = {
                            name: file.name,
                            type: file.type,
                            data: e.target.result,
                            timestamp: new Date().toISOString()
                        };
                        
                        state.fotos.push(fileData);
                        renderPhotoPreview(fileData);
                        showNotification('Foto adicionada', 'success');
                    };
                })(file);
                
                reader.readAsDataURL(file);
            }
            
            fotosInput.value = '';
        }

        function renderPhotoPreview(fileData) {
            const previewItem = document.createElement('div');
            previewItem.className = 'relative group';
            
            previewItem.innerHTML = `
                <img src="${fileData.data}" class="photo-preview cursor-pointer">
                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all duration-200 rounded-lg flex items-center justify-center opacity-0 group-hover:opacity-100">
                    <button class="view-photo-btn p-2 bg-white rounded-full shadow-lg text-gray-800 mr-1" data-index="${state.fotos.length - 1}">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="delete-photo-btn p-2 bg-white rounded-full shadow-lg text-red-600" data-index="${state.fotos.length - 1}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            fotosPreview.appendChild(previewItem);
            
            previewItem.querySelector('.view-photo-btn').addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                viewPhoto(index);
            });
            
            previewItem.querySelector('.delete-photo-btn').addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                deletePhoto(index);
            });
        }

        function viewPhoto(index) {
            const fileData = state.fotos[index];
            modalImage.src = fileData.data;
            imageModal.style.display = 'flex';
        }

        function deletePhoto(index) {
            state.fotos.splice(index, 1);
            renderPhotos();
            showNotification('Arquivo removido', 'info');
        }

        function renderPhotos() {
            fotosPreview.innerHTML = '';
            state.fotos.forEach((fileData, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'relative group';
                
                previewItem.innerHTML = `
                    <img src="${fileData.data}" class="photo-preview cursor-pointer">
                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all duration-200 rounded-lg flex items-center justify-center opacity-0 group-hover:opacity-100">
                        <button class="view-photo-btn p-2 bg-white rounded-full shadow-lg text-gray-800 mr-1" data-index="${index}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="delete-photo-btn p-2 bg-white rounded-full shadow-lg text-red-600" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                fotosPreview.appendChild(previewItem);
                
                previewItem.querySelector('.view-photo-btn').addEventListener('click', function() {
                    const idx = parseInt(this.getAttribute('data-index'));
                    viewPhoto(idx);
                });
                
                previewItem.querySelector('.delete-photo-btn').addEventListener('click', function() {
                    const idx = parseInt(this.getAttribute('data-index'));
                    deletePhoto(idx);
                });
            });
        }

        function addMaterial() {
            const material = materialInput.value.trim();
            const qtd = materialQtd.value.trim();
            
            if (!material || !qtd || Number(qtd) <= 0) {
                showNotification('Preencha o material e a quantidade v√°lida', 'error');
                return;
            }
            
            let codigo = '';
            let descricao = material;
            
            if (material.indexOf(' ‚Äî ') !== -1) {
                const parts = material.split(' ‚Äî ');
                codigo = parts[0].trim();
                descricao = parts.slice(1).join(' ‚Äî ').trim();
            } else if (/^\d+/.test(material)) {
                codigo = material;
                descricao = '';
            }
            
            state.materiais.push({
                codigo,
                descricao: descricao || material,
                quantidade: Number(qtd)
            });
            
            materialInput.value = '';
            materialQtd.value = '';
            renderMateriais();
            showNotification('Material adicionado', 'success');
        }

        function renderMateriais() {
            materiaisLista.innerHTML = '';
            
            state.materiais.forEach((item, index) => {
                const materialItem = document.createElement('div');
                materialItem.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg';
                materialItem.innerHTML = `
                    <div>
                        <span class="font-medium">${item.descricao}</span>
                        ${item.codigo ? `<span class="text-sm text-gray-500 ml-2">(${item.codigo})</span>` : ''}
                        <span class="text-blue-600 font-semibold ml-2">- ${item.quantidade} un.</span>
                    </div>
                    <button class="delete-material-btn text-red-500 hover:text-red-700 transition" data-index="${index}">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                
                materiaisLista.appendChild(materialItem);
            });
            
            document.querySelectorAll('.delete-material-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    state.materiais.splice(index, 1);
                    renderMateriais();
                    showNotification('Material removido', 'info');
                });
            });
        }

        function exportData() {
            if (!validateForm()) return;

            const formData = collectFormData();
            
            const dataToExport = {
                formData: formData,
                fotos: state.fotos,
                materiais: state.materiais,
                assinaturas: state.assinaturas,
                exportTimestamp: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            
            const cliente = formData.cliente.replace(/[^a-zA-Z0-9]/g, '_');
            const data = new Date().toISOString().split('T')[0];
            link.download = `servico_${cliente}_${data}.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showNotification('Dados exportados com sucesso!', 'success');
            setTimeout(() => {
                try {
                    gerarPDFsAutomaticamente(formData, state.materiais, state.fotos, state.assinaturas);
                } catch (err) {
                    console.error('Erro ao gerar PDFs:', err);
                }
            }, 500);
        }

        async function startApp() {
            try {
                try {
                    await initDB();
                } catch (dbError) {
                    console.error('Erro cr√≠tico no banco de dados:', dbError);
                    await recriarBancoDados();
                }
                
                initSync();
                await renderFormulariosSalvos();
                
                updateOnlineStatus();
                window.addEventListener('online', updateOnlineStatus);
                window.addEventListener('offline', updateOnlineStatus);
                setupEventListeners();
                setupSignatureCanvas(canvasCliente, ctxCliente, 'cliente');
                setupSignatureCanvas(canvasTecnico, ctxTecnico, 'tecnico');
                populateMaterialsDatalist();

                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('./sw.js?v=59')
                            .then(reg => {
                                console.log('Service Worker registrado. Scope:', reg.scope);
                            })
                            .catch(error => {
                                console.error('Falha no registro do Service Worker:', error);
                            });
                    });
                }
                
            } catch (error) {
                console.error("Falha ao iniciar a aplica√ß√£o:", error);
                showNotification('Erro ao inicializar aplica√ß√£o. Recarregue a p√°gina.', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', startApp);
    </script>
</body>
</html>
