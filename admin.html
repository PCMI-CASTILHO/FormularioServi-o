<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Formul√°rios - Selaves</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/simple-datatables@9.0.4" defer></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/2.1.7/css/dataTables.tailwindcss.css">
  <script src="https://cdn.datatables.net/2.1.7/js/dataTables.min.js"></script>
</head>

<body class="bg-gray-50 p-6 min-h-screen">
  <header class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-800">üìã Formul√°rios Sincronizados</h1>
    <button onclick="window.history.back()" class="btn-secondary px-4 py-2 rounded-lg">
      <i class="fas fa-arrow-left mr-2"></i> Voltar
    </button>
  </header>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <div class="bg-white shadow p-4 rounded">
      <h3 class="text-lg font-semibold mb-2">Servi√ßos por Tipo</h3>
      <canvas id="grafico-servicos"></canvas>
    </div>
    <div class="bg-white shadow p-4 rounded">
      <h3 class="text-lg font-semibold mb-2">Servi√ßos por T√©cnico</h3>
      <canvas id="grafico-tecnicos"></canvas>
    </div>
  </div>

  <div class="bg-white shadow p-6 rounded">
    <h3 class="text-xl font-semibold mb-4">Lista de Formul√°rios</h3>
    <table id="tabela" class="display w-full">
      <thead>
        <tr>
          <th>ID</th>
          <th>Cliente</th>
          <th>T√©cnico</th>
          <th>Servi√ßo</th>
          <th>Data</th>
          <th>Ver</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Modal de visualiza√ß√£o -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg max-w-4xl w-full p-6 relative overflow-y-auto max-h-[90vh]">
      <button id="close-modal" class="absolute top-3 right-3 text-gray-600 text-2xl">&times;</button>
      <h2 id="modal-titulo" class="text-2xl font-bold mb-4 text-gray-800">Ficha de Servi√ßo</h2>
      <div id="modal-conteudo" class="text-gray-700 space-y-2"></div>
      <div class="text-right mt-4">
        <button id="baixar-btn" class="btn-primary px-4 py-2 rounded">
          <i class="fas fa-download mr-2"></i> Baixar PDF
        </button>
      </div>
    </div>
  </div>

<script>
  async function carregar() {
    try {
      const res = await fetch('https://vps.pesoexato.com/servico_list');
      if (!res.ok) throw new Error(`Erro HTTP ${res.status}`);

      const dadosBrutos = await res.json();
      console.log("üì¶ Dados recebidos do servidor:", dadosBrutos);

      // Decodifica o JSON interno (json_dados)
      const dados = dadosBrutos.map(item => {
        const interno = JSON.parse(item.json_dados || "{}");
        return {
          id: item.id,
          chave: item.chave,
          dtalteracao: item.dtalteracao,
          ...interno,
          ...interno.formData // espalha os campos do formData tamb√©m
        };
      });

      console.log("‚úÖ Dados tratados:", dados);

      // --- GR√ÅFICOS ---
      const tipos = {}, tecnicos = {};
      dados.forEach(f => {
        const tipo = f.servico || 'OUTRO';
        const tecnico = f.tecnico || f.tecnicoNome || 'N√£o informado';
        tipos[tipo] = (tipos[tipo] || 0) + 1;
        tecnicos[tecnico] = (tecnicos[tecnico] || 0) + 1;
      });

      new Chart(document.getElementById('grafico-servicos'), {
        type: 'pie',
        data: { labels: Object.keys(tipos), datasets: [{ data: Object.values(tipos) }] }
      });
      new Chart(document.getElementById('grafico-tecnicos'), {
        type: 'bar',
        data: { labels: Object.keys(tecnicos), datasets: [{ data: Object.values(tecnicos), backgroundColor: '#3b82f6' }] }
      });

      // --- TABELA ---
      const tbody = document.querySelector('#tabela tbody');
      tbody.innerHTML = '';
      dados.forEach(f => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${f.id}</td>
          <td>${f.cliente || '-'}</td>
          <td>${f.tecnico || f.tecnicoNome || '-'}</td>
          <td>${f.servico || '-'}</td>
          <td>${f.dataInicial || '-'}</td>
          <td><button class="text-blue-600 underline" onclick="abrirFicha(${f.id})">Ver</button></td>
        `;
        tbody.appendChild(tr);
      });

      // ‚úÖ Corrigido: uso correto do simple-datatables
      new simpleDatatables.DataTable('#tabela', {
        perPage: 10,
        labels: {
          placeholder: 'Buscar...',
          noRows: 'Nenhum registro encontrado',
          perPage: '{select} registros por p√°gina',
          info: 'Mostrando {start}‚Äì{end} de {rows}'
        }
      });

      window.formularios = dados;
    } catch (erro) {
      console.error("‚ùå Erro ao carregar dados:", erro);
      document.body.innerHTML = `
        <div class="text-center mt-20 text-red-600">
          <h2 class="text-2xl font-bold mb-4">Falha ao carregar formul√°rios</h2>
          <p>${erro.message}</p>
        </div>`;
    }
  }

  // --- Visualiza√ß√£o detalhada ---
  function abrirFicha(id) {
    const f = (window.formularios || []).find(x => x.id === id);
    if (!f) return alert("Formul√°rio n√£o encontrado.");

    document.getElementById('modal').classList.remove('hidden');
    document.getElementById('modal-titulo').innerText = `${f.servico} - ${f.cliente}`;
    document.getElementById('modal-conteudo').innerHTML = `
      <p><strong>T√©cnico:</strong> ${f.tecnico || f.tecnicoNome}</p>
      <p><strong>Cidade:</strong> ${f.cidade}</p>
      <p><strong>Equipamento:</strong> ${f.equipamento}</p>
      <p><strong>Data Inicial:</strong> ${f.dataInicial} ${f.horaInicial}</p>
      <p><strong>Data Final:</strong> ${f.dataFinal} ${f.horaFinal}</p>
      <p><strong>Relat√≥rio:</strong><br>${f.relatorioMaquina || '-'}</p>
    `;
    document.getElementById('baixar-btn').onclick = () => baixarFicha(f);
  }

  document.getElementById('close-modal').onclick = () => 
    document.getElementById('modal').classList.add('hidden');

  // --- Baixar como PDF ---
  async function baixarFicha(f) {
    const { jsPDF } = window.jspdf || await import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
    const doc = new jsPDF();
    doc.text(`Ficha de Servi√ßo - ${f.cliente}`, 10, 10);
    doc.text(`T√©cnico: ${f.tecnico}`, 10, 20);
    doc.text(`Servi√ßo: ${f.servico}`, 10, 30);
    doc.text(`Relat√≥rio:`, 10, 40);
    doc.text(f.relatorioMaquina || '', 10, 50);
    doc.save(`servico_${f.id}.pdf`);
  }

  carregar();
</script>
</body>
</html>
