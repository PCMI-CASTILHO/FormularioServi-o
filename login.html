<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Sistema Selaves</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/idb@8/build/umd.js"></script>

    <style>
        /* 1. Animação CSS para os Cards de Usuário */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* 1. Animação para Notificação */
        @keyframes slideIn {
            from {
                right: -300px;
                opacity: 0;
            }
            to {
                right: 1rem;
                opacity: 1;
            }
        }

        .animate-slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }

        /* Estilos base */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1d4ed8 0%, #4f46e5 100%);
        }

        .login-card {
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .user-card {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer;
            border: 2px solid transparent;
            user-select: none;
            
            /* Aplica a animação de entrada */
            opacity: 0; /* Inicia invisível */
            animation: fadeInUp 0.5s ease-out forwards;
        }

        /* 4. Atraso na Animação para efeito cascata */
        .user-card:nth-child(1) { animation-delay: 0.1s; }
        .user-card:nth-child(2) { animation-delay: 0.2s; }
        .user-card:nth-child(3) { animation-delay: 0.3s; }
        .user-card:nth-child(4) { animation-delay: 0.4s; }
        .user-card:nth-child(5) { animation-delay: 0.5s; }
        /* Adicione mais se espera ter mais de 5 usuários padrão */


        .user-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
            background: #f0f9ff;
        }

        .user-card.selected {
            border-color: #2563eb;
            background: #e0f2fe;
            transform: translateY(0);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.5);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="login-card rounded-3xl p-10 max-w-4xl w-full">
        <div class="text-center mb-10">
            <div class="bg-blue-600 text-white p-5 rounded-full inline-block mb-4 shadow-lg">
                <i class="fas fa-screwdriver-wrench text-3xl"></i>
            </div>
            <h1 class="text-3xl font-extrabold text-gray-900 mb-2 tracking-tight">Sistema Selaves</h1>
            <p class="text-gray-500 text-lg">Selecione seu perfil de acesso para continuar</p>
        </div>

        <div id="users-list" class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
            </div>

        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <button id="login-btn" disabled class="bg-blue-600 text-white px-10 py-4 rounded-xl font-bold text-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition transform hover:scale-[1.02]">
                <i class="fas fa-sign-in-alt mr-2"></i> Entrar no Sistema
            </button>
            <button id="manage-users-btn" class="bg-gray-200 text-gray-800 px-10 py-4 rounded-xl font-semibold text-lg hover:bg-gray-300 transition transform hover:scale-[1.02]">
                <i class="fas fa-users-cog mr-2"></i> Gerenciar Perfis
            </button>
        </div>
    </div>

    <div id="manage-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto transform scale-100 transition-transform duration-300">
            <div class="flex justify-between items-center mb-8 pb-4 border-b border-gray-200">
                <h2 class="text-3xl font-bold text-gray-800">
                    <i class="fas fa-users-cog text-blue-600 mr-2"></i> Gerenciar Usuários
                </h2>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100 transition">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="bg-blue-50 p-6 rounded-xl mb-8 border border-blue-200">
                <h3 class="text-xl font-bold text-blue-800 mb-4">Adicionar Novo Usuário</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Nome Completo *</label>
                        <input type="text" id="new-user-name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm" placeholder="Ex: João Silva ou Técnico Líder">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ID do Usuário *</label>
                        <input type="number" id="new-user-id" min="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm" placeholder="Ex: 101">
                        <p class="text-xs text-gray-500 mt-1">Este ID deve ser único (Ex: 1-0001)</p>
                    </div>
                    <button id="add-user-btn" class="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition w-full sm:w-auto">
                        <i class="fas fa-plus mr-2"></i> Adicionar Usuário
                    </button>
                </div>
            </div>

            <div>
                <h3 class="text-xl font-bold text-gray-800 mb-4">Usuários Cadastrados</h3>
                <div id="manage-users-list" class="space-y-3">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // ======== CONFIGURAÇÃO DO INDEXEDDB ========
        const DB_NAME = 'FormulariosDB';
        const DB_VERSION = 2;
        const STORE_FORMULARIOS = 'formularios';
        const STORE_USUARIOS = 'usuarios';
        let dbPromise;
        let selectedUserId = null;
        let lastSelectedCard = null;
        const loginBtn = document.getElementById('login-btn');

        // Inicializa DB com ambas as stores
        function initDB() {
            if (dbPromise) return dbPromise;
            dbPromise = idb.openDB(DB_NAME, DB_VERSION, {
                upgrade(db, oldVersion, newVersion, transaction) {
                    if (!db.objectStoreNames.contains(STORE_FORMULARIOS)) {
                        const storeFormularios = db.createObjectStore(STORE_FORMULARIOS, { keyPath: 'id' });
                        storeFormularios.createIndex('cliente', 'cliente', { unique: false });
                        storeFormularios.createIndex('servico', 'servico', { unique: false });
                        storeFormularios.createIndex('userId', 'userId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORE_USUARIOS)) {
                        const storeUsuarios = db.createObjectStore(STORE_USUARIOS, { keyPath: 'id' });
                        storeUsuarios.createIndex('nome', 'nome', { unique: false });
                        
                        // Adiciona índice para o novo campo lastLogin
                        storeUsuarios.createIndex('lastLogin', 'lastLogin', { unique: false }); 
                    }
                },
            });
            return dbPromise;
        }

        // ======== FUNÇÃO DE NOTIFICAÇÃO (1. Feedback visual ao adicionar usuário) ========
        function showSuccessNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-xl shadow-2xl z-50 animate-slide-in font-semibold';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('animate-slide-in');
                // Adiciona animação de saída (opcional, mas melhora a UX)
                notification.style.animation = 'slideIn 0.3s ease-in reverse forwards';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ======== FUNÇÃO DE FORMATAR DATA (3. Indicador de "último acesso") ========
        function formatLastLogin(isoString) {
            if (!isoString) return 'Nunca';
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));

            if (diffHours < 1) {
                const diffMinutes = Math.floor(diffMs / (1000 * 60));
                return `Há ${diffMinutes} min`;
            } else if (diffHours < 24) {
                return `Hoje, ${date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
            } else if (diffHours < 48) {
                return `Ontem, ${date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
            } else {
                return date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
            }
        }

        // ======== GERENCIAMENTO DE USUÁRIOS ========
        async function loadUsers() {
            const db = await initDB();
            let users = await db.getAll(STORE_USUARIOS);
            
            if (users.length === 0) {
                const defaultUsers = [
                    { id: 1, nome: 'Técnico Principal', lastSequence: 0, lastLogin: null },
                    { id: 2, nome: 'Técnico de Campo', lastSequence: 0, lastLogin: null },
                    { id: 3, nome: 'Usuário Administrativo', lastSequence: 0, lastLogin: null }
                ];
                const tx = db.transaction(STORE_USUARIOS, 'readwrite');
                for (const user of defaultUsers) {
                    await tx.store.put(user);
                }
                await tx.done;
                users = defaultUsers;
            }
            return users.sort((a, b) => a.id - b.id);
        }

        async function addUser(id, nome) {
            if (!id || !nome) {
                alert('Preencha todos os campos!');
                return false;
            }
            const db = await initDB();
            const existing = await db.get(STORE_USUARIOS, parseInt(id));
            if (existing) {
                alert('Já existe um usuário com este ID!');
                return false;
            }
            await db.put(STORE_USUARIOS, {
                id: parseInt(id),
                nome: nome.trim(),
                lastSequence: 0,
                lastLogin: null // Novo campo
            });
            return true;
        }

        async function loginUser(userId) {
            const db = await initDB();
            const user = await db.get(STORE_USUARIOS, userId);
            
            // 3. Salva o timestamp do último login no DB e na Session Storage
            const now = new Date().toISOString();
            await db.put(STORE_USUARIOS, { ...user, lastLogin: now });
            
            sessionStorage.setItem('currentUser', JSON.stringify({ ...user, lastLogin: now }));
            
            // Redireciona
            console.log(`Usuário ${user.nome} (ID: ${user.id}) logado. Redirecionando...`); 
            window.location.href = 'index.html';
        }

        async function deleteUser(id) {
            if (!confirm('Tem certeza que deseja excluir este usuário?')) return;
            const db = await initDB();
            await db.delete(STORE_USUARIOS, id);
            if (selectedUserId === id) {
                selectedUserId = null;
                loginBtn.disabled = true;
            }
            await renderManageUsers();
            await renderUsersList();
        }

        // ======== RENDERIZAÇÃO DA UI ========
        async function renderUsersList() {
            const usersList = document.getElementById('users-list');
            const users = await loadUsers();
            
            usersList.innerHTML = users.map(user => `
                <div class="user-card bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all border-2 border-transparent" data-user-id="${user.id}">
                    <div class="text-center">
                        <div class="bg-blue-100 text-blue-600 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-3 shadow-inner">
                            <i class="fas fa-user-circle text-4xl"></i>
                        </div>
                        <h3 class="font-bold text-lg text-gray-800 truncate">${user.nome}</h3>
                        <p class="text-sm text-gray-500 mt-1">Último acesso: <span class="font-semibold text-gray-600">${formatLastLogin(user.lastLogin)}</span></p>
                        <p class="text-xs text-gray-400 mt-2">ID: ${user.id} | Ficha Recente: ${user.id}-${String(user.lastSequence).padStart(4, '0')}</p>
                    </div>
                </div>
            `).join('');

            // Adicionar event listeners para seleção
            document.querySelectorAll('.user-card').forEach(card => {
                const userId = parseInt(card.dataset.userId);

                if (selectedUserId === userId) {
                    card.classList.add('selected');
                    lastSelectedCard = card;
                    loginBtn.disabled = false;
                }

                card.addEventListener('click', function() {
                    if (lastSelectedCard) {
                        lastSelectedCard.classList.remove('selected');
                    }
                    
                    this.classList.add('selected');
                    lastSelectedCard = this;
                    selectedUserId = userId;
                    loginBtn.disabled = false;
                });
            });
        }

        async function renderManageUsers() {
            const manageList = document.getElementById('manage-users-list');
            const users = await loadUsers();
            if (users.length === 0) {
                manageList.innerHTML = '<p class="text-gray-500 text-center py-4 italic">Nenhum usuário cadastrado. Adicione um acima.</p>';
                return;
            }
            manageList.innerHTML = users.map(user => `
                <div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg shadow-sm border-l-4 border-blue-500">
                    <div>
                        <p class="font-bold text-gray-800">${user.nome}</p> 
                        <p class="text-sm text-gray-500 mt-1">ID: ${user.id} | Última Ficha: ${String(user.lastSequence).padStart(4, '0')} | Último Login: ${formatLastLogin(user.lastLogin)}</p>
                    </div>
                    <button onclick="deleteUser(${user.id})" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50 transition" title="Excluir Usuário">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `).join('');
        }

        // ======== EVENT LISTENERS ========
        document.getElementById('login-btn').addEventListener('click', async function() {
            if (!selectedUserId) return;
            await loginUser(selectedUserId);
        });

        // 2. Atalho de teclado (Enter para logar)
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && selectedUserId && !loginBtn.disabled) {
                // Previne a ação padrão (como submeter formulário no modal)
                e.preventDefault(); 
                loginBtn.click();
            }
        });

        // Toggle do Modal
        const manageModal = document.getElementById('manage-modal');
        const closeBtn = document.getElementById('close-modal-btn');
        const manageUsersBtn = document.getElementById('manage-users-btn');

        manageUsersBtn.addEventListener('click', async function() {
            manageModal.classList.remove('hidden');
            manageModal.classList.add('opacity-100');
            await renderManageUsers();
        });

        const closeModal = () => {
             manageModal.classList.add('hidden');
             manageModal.classList.remove('opacity-100');
        };

        closeBtn.addEventListener('click', closeModal);
        manageModal.addEventListener('click', (e) => {
            if (e.target === manageModal) {
                closeModal();
            }
        });

        // 1. Feedback visual ao adicionar usuário (substituindo o alert)
        document.getElementById('add-user-btn').addEventListener('click', async function() {
            const name = document.getElementById('new-user-name').value;
            const id = document.getElementById('new-user-id').value;
            if (await addUser(id, name)) {
                document.getElementById('new-user-name').value = '';
                document.getElementById('new-user-id').value = '';
                await renderManageUsers();
                await renderUsersList();
                // Notificação de sucesso
                showSuccessNotification('✅ Usuário adicionado com sucesso! Selecione para entrar.');
            }
        });

        // Tornar deleteUser global para o onclick
        window.deleteUser = deleteUser;

        // ======== INICIALIZAÇÃO ========
        document.addEventListener('DOMContentLoaded', async function() {
            await initDB();
            await renderUsersList();
        });
    </script>
</body>
</html>
